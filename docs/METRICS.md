# Метрики KPI

## Обзор

Система собирает метрики для оценки работы приложения и бизнес-процессов. Метрики логируются в структурированном формате и могут быть извлечены из логов для анализа или экспортированы в системы мониторинга (например, Prometheus).

## Архитектура

Метрики собираются через `MetricsCollector`, который логирует события в структурированном формате. Каждая метрика содержит:
- `metric_type` - тип метрики
- Контекстные данные (ID пользователей, заказов и т.д.)
- `timestamp` - временная метка события

## Бизнес-метрики

### Регистрации

#### `blogger_registration`
**Описание:** Регистрация нового блогера

**Контекст:**
- `user_id` - UUID пользователя

**Пример:**
```json
{
  "metric_type": "blogger_registration",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2026-01-21T15:30:45.123456"
}
```

#### `advertiser_registration`
**Описание:** Регистрация нового рекламодателя

**Контекст:**
- `user_id` - UUID пользователя

### Заказы

#### `order_created`
**Описание:** Создание нового заказа

**Контекст:**
- `order_id` - UUID заказа
- `advertiser_id` - UUID рекламодателя
- `price` - цена заказа (float)
- `bloggers_needed` - количество требуемых блогеров (int)

**Пример:**
```json
{
  "metric_type": "order_created",
  "order_id": "660e8400-e29b-41d4-a716-446655440001",
  "advertiser_id": "550e8400-e29b-41d4-a716-446655440000",
  "price": 15000.0,
  "bloggers_needed": 3,
  "timestamp": "2026-01-21T15:30:45.123456"
}
```

#### `order_paid`
**Описание:** Оплата заказа

**Контекст:**
- `order_id` - UUID заказа
- `payment_id` - UUID платежа
- `amount` - сумма платежа (float)
- `time_to_payment_seconds` - время от создания заказа до оплаты (опционально)

**Пример:**
```json
{
  "metric_type": "order_paid",
  "order_id": "660e8400-e29b-41d4-a716-446655440001",
  "payment_id": "770e8400-e29b-41d4-a716-446655440002",
  "amount": 15000.0,
  "time_to_payment_seconds": 3600.5,
  "timestamp": "2026-01-21T16:30:45.123456"
}
```

#### `payment_failed`
**Описание:** Неудачная попытка оплаты

**Контекст:**
- `order_id` - UUID заказа
- `reason` - причина ошибки (str)

### Отклики и контакты

#### `blogger_response`
**Описание:** Отклик блогера на заказ

**Контекст:**
- `order_id` - UUID заказа
- `blogger_id` - UUID блогера

#### `contacts_sent`
**Описание:** Передача контактов рекламодателю

**Контекст:**
- `order_id` - UUID заказа
- `blogger_id` - UUID блогера
- `advertiser_id` - UUID рекламодателя
- `time_to_contacts_seconds` - время от создания заказа до передачи контактов (опционально)

## Технические метрики

### Блокировки

#### `user_blocked`
**Описание:** Блокировка пользователя

**Контекст:**
- `user_id` - UUID пользователя
- `reason` - причина блокировки (str)

**Пример:**
```json
{
  "metric_type": "user_blocked",
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "reason": "Status changed from ACTIVE",
  "timestamp": "2026-01-21T15:30:45.123456"
}
```

### Жалобы

#### `complaint_created`
**Описание:** Создание жалобы

**Контекст:**
- `complaint_id` - UUID жалобы
- `reporter_id` - UUID пользователя, подавшего жалобу
- `reported_id` - UUID пользователя, на которого пожаловались
- `order_id` - UUID заказа
- `reason` - причина жалобы (str)

#### `complaint_status_changed`
**Описание:** Изменение статуса жалобы

**Контекст:**
- `complaint_id` - UUID жалобы
- `old_status` - предыдущий статус
- `new_status` - новый статус

### Взаимодействия

#### `interaction_issue`
**Описание:** Взаимодействие со статусом ISSUE

**Контекст:**
- `interaction_id` - UUID взаимодействия
- `order_id` - UUID заказа
- `blogger_id` - UUID блогера
- `advertiser_id` - UUID рекламодателя

#### `feedback_postponement`
**Описание:** Перенос фидбека на 72 часа

**Контекст:**
- `interaction_id` - UUID взаимодействия
- `postpone_count` - количество переносов (int)

**Пример:**
```json
{
  "metric_type": "feedback_postponement",
  "interaction_id": "880e8400-e29b-41d4-a716-446655440003",
  "postpone_count": 1,
  "timestamp": "2026-01-21T15:30:45.123456"
}
```

### Производительность

#### `request_latency`
**Описание:** Время выполнения операции

**Контекст:**
- `operation` - название операции (str)
- `duration_seconds` - длительность в секундах (float)
- `success` - успешность операции (bool)

## Расчетные метрики

На основе собранных метрик можно рассчитать следующие KPI:

### Конверсии

1. **Конверсия заказов в оплаты:**
   ```
   (количество order_paid) / (количество order_created) * 100%
   ```

2. **Конверсия оплат в контакты:**
   ```
   (количество contacts_sent) / (количество order_paid) * 100%
   ```

3. **Общая конверсия:**
   ```
   (количество contacts_sent) / (количество order_created) * 100%
   ```

### Средние времена

1. **Среднее время от создания заказа до оплаты:**
   ```
   Среднее значение time_to_payment_seconds для всех order_paid
   ```

2. **Среднее время от оплаты до передачи контактов:**
   ```
   Среднее значение time_to_contacts_seconds для всех contacts_sent
   ```

### Статистика по периодам

Метрики можно агрегировать по периодам (день, неделя, месяц):
- Количество регистраций блогеров/рекламодателей
- Количество созданных заказов
- Количество оплаченных заказов
- Количество откликов
- Количество переданных контактов

## Интеграция с системами мониторинга

### Prometheus

Метрики можно экспортировать в Prometheus через endpoint `/metrics`. Для этого нужно:
1. Парсить JSON-логи с `metric_type`
2. Конвертировать в формат Prometheus
3. Экспортировать через HTTP endpoint

### Grafana

Метрики можно визуализировать в Grafana, подключив источник данных (Prometheus или напрямую из логов).

## Примеры запросов

### Количество регистраций за день
```python
# Фильтр в логах
metric_type:blogger_registration AND timestamp:[2026-01-21T00:00:00 TO 2026-01-21T23:59:59]
```

### Конверсия заказов в оплаты за неделю
```python
# Подсчет order_created и order_paid за период
orders_created = count(metric_type:order_created AND timestamp:[...])
orders_paid = count(metric_type:order_paid AND timestamp:[...])
conversion_rate = orders_paid / orders_created * 100
```

### Среднее время до оплаты
```python
# Агрегация time_to_payment_seconds
avg(metric_type:order_paid.time_to_payment_seconds)
```

## Экспорт в Prometheus (планируется)

В будущем метрики можно экспортировать в Prometheus: вынести сбор счётчиков (например, количество регистраций, заказов, ошибок) в отдельный HTTP endpoint (например, `/metrics`), отдающий формат Prometheus text. Тогда сборщик Prometheus будет скрейпить этот endpoint, а в Grafana можно строить дашборды по тем же KPI. Текущая реализация через структурированные логи позволяет извлекать метрики из логов (например, через Promtail/Loki или скрипты) до появления отдельного endpoint.

## Рекомендации

1. **Мониторинг критических метрик:** Настройте алерты на:
   - Резкое снижение конверсии
   - Увеличение количества блокировок
   - Увеличение количества жалоб
   - Увеличение времени обработки

2. **Регулярный анализ:** Проводите еженедельный анализ метрик для выявления трендов

3. **A/B тестирование:** Используйте метрики для оценки эффективности изменений

4. **Оптимизация:** Используйте метрики производительности для выявления узких мест
